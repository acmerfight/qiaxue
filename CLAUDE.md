# 项目说明

**这是一个微信小程序项目**
- 使用 TypeScript 开发
- 使用微信开发者工具进行编译和调试
- 遵循微信小程序开发规范

# 🚨 必须遵守的核心规范

## 1. 状态管理 - 使用 ccstate
- **所有状态使用 ccstate 管理** - 业务数据、用户状态、页面状态统一通过 ccstate 处理
- **页面只负责渲染和交互** - 页面文件仅处理 UI 展示和用户操作，不维护业务状态
- **状态变更通过专门函数** - 创建独立的状态管理函数，页面调用这些函数修改状态

## 2. 测试最佳实践 - 用户行为驱动测试

> **"不要测试代码是否正确，要测试用户是否能成功"**

### 🎯 核心测试理念：站在用户角度思考

#### 测试的本质目的：
- **保障用户体验** - 确保用户能顺利完成目标任务
- **验证业务价值** - 测试关键业务流程是否可靠
- **预防用户问题** - 在用户遇到问题前发现并修复
- **降低发布风险** - 通过模拟真实使用场景保证质量

#### 核心原则：
- **用户视角优先** - 从用户完整使用流程出发，而非从函数正确性出发
- **业务价值导向** - 测试用户能否完成关键任务，而非代码内部实现细节
- **真实场景模拟** - 避免过度mock，尽量模拟用户真实操作和系统响应
- **先写用户故事再写代码** - TDD从用户需求开始，不从技术实现开始

### 📊 用户行为测试分层 (5-15-80原则)

#### 🔧 工具函数测试 (5%) - 仅测关键工具
**只测试被多处使用且用户直接感知的工具函数**

```typescript
// ✅ 值得测试的工具函数 - 用户直接看到结果
test('时间显示格式对用户友好', () => {
  const result = formatTime(new Date(2023, 11, 25, 14, 30))
  expect(result).toBe('2023/12/25 14:30') // 用户看到的格式
})

// ❌ 不要测试的技术细节
test('formatTime函数返回string类型', () => {
  // 用户不关心返回类型，TypeScript已保证
})
```

适合测试的工具函数：
- **时间格式化、数据验证** - 直接影响用户体验
- **核心算法逻辑** - 计算错误会导致用户损失
- **不测试纯技术函数** - 状态管理、类型转换等

#### 🔗 集成测试 (15%) - 验证系统协作
**测试各个模块配合时用户能否正常使用**

```typescript
// ✅ 集成测试示例
test('用户更新头像后，个人中心立即显示新头像', () => {
  // 1. 模拟用户已登录状态
  setUserInfo({nickName: '用户', avatarUrl: 'old.jpg'})
  
  // 2. 用户更新头像
  updateUserAvatar('new.jpg')
  
  // 3. 验证用户在页面上能看到更新
  expect(getUserInfo()?.avatarUrl).toBe('new.jpg')
})
```

重点测试场景：
- **状态管理与页面同步** - 数据变化后页面显示是否正确
- **API与本地状态集成** - 网络请求后本地数据是否同步
- **跨组件数据流** - 一处修改，相关地方是否联动更新

#### 👤 用户行为测试 (80%) - 核心价值所在
**完整模拟用户从开始到结束的真实使用场景**

```typescript
// ✅ 优秀的用户行为测试
describe('新用户完整注册流程', () => {
  test('用户首次打开应用→微信授权→完善信息→成功使用', () => {
    // 1. 用户首次打开应用，看到登录页面
    expect(checkHasUserInfo()).toBe(false)
    
    // 2. 用户点击微信授权，系统获取基本信息
    const wechatInfo = {nickName: '微信用户', avatarUrl: 'wx.jpg'}
    setUserInfo(wechatInfo)
    
    // 3. 用户进入个人中心，选择更新头像
    updateUserAvatar('custom.jpg')
    
    // 4. 用户成功完成注册，可以正常使用应用功能
    expect(checkHasUserInfo()).toBe(true)
    expect(getUserInfo()?.avatarUrl).toBe('custom.jpg')
  })
})

describe('异常场景用户体验', () => {
  test('网络异常时用户能否正常恢复使用', () => {
    // 模拟网络请求失败场景下的用户体验
  })
})
```

必须覆盖的用户场景：
- **新用户首次使用流程** - 从下载到成功使用
- **老用户返回体验** - 重新打开应用的流程
- **核心功能完整流程** - 用户主要任务的端到端测试
- **异常恢复场景** - 出错时用户如何继续使用

### 🚫 避免的低价值测试类型

#### 立即删除这些测试：
- **函数返回类型验证** - `expect(typeof result).toBe('string')`
- **内部实现细节测试** - 测试私有方法、内部状态结构
- **过度技术化验证** - 正则匹配、格式检查等用户无感知的测试
- **重复场景测试** - 多个测试验证同一个用户使用场景

#### 保留这些高价值测试：
- **用户完整操作流程** - 从开始到结束的真实使用场景
- **异常情况恢复能力** - 用户遇到错误后能否继续使用
- **关键业务节点验证** - 登录、支付、数据保存等不能失败的操作

### 🎯 测试价值判断标准

#### 测试前问自己这3个问题：

1. **"这个测试失败时，用户会遇到问题吗？"**
   - 是 → 高价值测试，必须保留
   - 否 → 低价值测试，考虑删除

2. **"产品经理能看懂这个测试在验证什么吗？"**
   - 是 → 业务价值明确，贴近用户需求
   - 否 → 过于技术化，偏离用户关注点

3. **"这个测试模拟了真实的用户操作吗？"**
   - 是 → 有效的行为测试
   - 否 → 可能是无意义的单元测试

### 📝 用户行为测试编写指南

#### 测试描述使用用户语言：
```typescript
// ✅ 用户能理解的描述
test('用户修改昵称后，个人中心立即显示新昵称')
test('网络断开时，用户看到"请检查网络连接"提示')
test('用户登出后，重新进入需要再次登录')

// ❌ 技术术语描述
test('updateUserInfo函数正确更新userInfoState')
test('网络请求失败时catch块被执行')
test('clearUserInfo将hasUserInfo设置为false')
```

#### 测试场景保持完整性：
每个用户行为测试都应包含：
- **起始状态** - 用户在什么情况下开始这个操作
- **操作步骤** - 用户执行了哪些具体动作
- **预期结果** - 用户应该看到什么、能做什么
- **异常处理** - 出错时用户如何恢复继续使用

### 🎮 测试运行命令
```bash
# 运行所有测试
npm test

# 监听模式运行测试（开发时推荐）
npm run test:watch

# 运行测试并生成覆盖率报告
npm run test:coverage
```

### ⚡ 用户行为测试检查清单

#### 编码前：用户需求分析
- [ ] 我能完整描述用户使用这个功能的场景吗？
- [ ] 这个功能失败时，用户会遇到什么具体问题？
- [ ] 已有测试是否覆盖了类似的用户使用场景？
- [ ] 用户最关心这个功能的哪个方面？

#### 编码中：用户体验验证
- [ ] 测试是否模拟了真实的用户操作序列？
- [ ] 测试描述能否让产品经理一眼看懂在验证什么？
- [ ] 测试失败时，能否直接定位到用户体验问题？
- [ ] 是否避免了过度mock，保持了真实的系统行为？
- [ ] 异常情况下，用户能否正常恢复继续使用？

#### 提交前：价值验证
- [ ] 关键用户流程是否100%覆盖？
- [ ] 删除了技术化的、用户无感知的测试吗？
- [ ] 测试运行时间是否合理（<5秒）？
- [ ] 每个测试都能回答"用户能否成功"这个问题吗？

#### 测试价值自查（必答3问）：
- [ ] **这个测试失败时，用户会受影响吗？**
- [ ] **这个测试验证的是用户场景还是代码实现？**
- [ ] **去掉这个测试，我还敢向用户发布这个功能吗？**

## 3. TypeScript 类型检查
### 编码要求
- **禁用 any 类型** - 除极特殊情况外，不使用 any，用 unknown 替代
- **定义完整接口** - 所有数据结构、API 响应、状态对象都要有明确 interface
- **函数类型注解** - 所有函数参数和返回值必须声明类型

### 提交前必须执行
**每次代码修改后必须运行以下命令并确保全部通过**
```bash
# 1. 运行所有测试（必须 100% 通过）
npm test

# 2. 运行 TypeScript 类型检查（必须无错误）
npx tsc --noEmit
```
- **测试必须 100% 通过** - 任何测试失败都不允许提交
- **类型检查必须无错误** - 任何 TypeScript 错误都不允许提交
- **TDD 流程** - 新功能必须先写测试，确保测试失败，然后实现功能使测试通过

## 4. Git 提交规范
### 自动提交要求
每次修改文件后必须自动进行 commit。

### 提交信息格式
```
<type>(<scope>): <subject>

<body>
```

**Type 类型**：
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档修改
- `style`: 代码格式修改（不影响代码运行）
- `refactor`: 重构代码
- `test`: 测试用例修改
- `chore`: 构建过程或辅助工具的变动

**Scope 范围**（可选）：
- `pages`: 页面相关
- `components`: 组件相关
- `utils`: 工具函数
- `config`: 配置文件
- `api`: 接口相关

# 📋 编码细节规范

## 错误处理规范
- **严格遵循 Fail-Fast 机制** - 遇到不能处理的错误必须立即抛出，绝对不能静默处理
- **禁止空 catch 块** - 不允许 `catch(e) {}` 这种什么都不做的异常处理
- **明确错误边界** - 错误应该在合适的层级被处理，不能在底层吞掉所有异常
- **记录关键错误** - 重要的错误信息必须记录，便于调试和追踪

## 函数设计规范
- **尽量少使用默认参数** - 默认参数会让代码难以理解，优先使用明确的参数传递
- **函数职责单一** - 每个函数只做一件事，避免参数过多和逻辑复杂
- **参数语义明确** - 参数名称要能清楚表达含义，避免使用 flag、data 等模糊名称

## 数据安全规范
- **禁止硬编码敏感信息** - API密钥、用户凭证、服务器地址等必须通过环境变量或配置文件管理
- **用户数据脱敏** - 日志中不能包含用户隐私信息（手机号、密码、身份证等）
- **接口权限验证** - 所有接口调用必须有合适的权限检查，验证用户身份
- **数据传输加密** - 敏感数据传输必须使用 HTTPS，重要数据考虑额外加密

## 生命周期管理
- **清理定时器** - 页面 onUnload 时必须清理所有 setTimeout/setInterval
- **取消请求** - 页面销毁时取消未完成的网络请求，避免回调执行报错
- **事件解绑** - 组件销毁时解绑全局事件监听，防止内存泄漏
- **资源释放** - 及时释放大对象引用、关闭 WebSocket 连接等

# 💡 微信小程序特殊说明

## TypeScript 配置 - 无需关注的问题
- **无需安装 typescript 包** - 微信开发者工具内置 TypeScript 编译器
- **无需 outDir/rootDir** - 微信开发者工具自动处理编译输出
- **无需复杂的模块解析配置** - 小程序有自己的模块系统
- **当前 tsconfig.json 已足够严格** - 已启用 strict 模式和各种检查

## 已配置完善的部分
- project.config.json 已启用 typescript 插件
- typings 目录提供完整的微信 API 类型定义
- miniprogram-api-typings 提供官方类型支持

# ⚡ 快速检查清单

编码前：
- [ ] 我能完整描述用户使用这个功能的场景吗？
- [ ] 已有测试是否覆盖了类似的用户使用场景？
- [ ] 状态管理是否使用 ccstate？

编码中：
- [ ] 是否避免使用 any 类型？
- [ ] 函数是否有完整的类型注解？
- [ ] 测试是否模拟了真实的用户操作？
- [ ] 测试描述能否让产品经理看懂？
- [ ] 错误是否正确处理（无空 catch）？
- [ ] 是否有硬编码的敏感信息？

提交前：
- [ ] 运行 `npm test` 100% 通过？
- [ ] 运行 `npx tsc --noEmit` 无错误？
- [ ] 关键用户流程是否100%覆盖？
- [ ] 删除了技术化的、用户无感知的测试吗？
- [ ] Git 提交信息格式正确？
- [ ] 生命周期是否正确管理？