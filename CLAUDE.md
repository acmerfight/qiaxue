# 微信小程序项目 - 开发规范

**项目基础**：TypeScript + 微信开发者工具 + 自定义状态管理

---

# 🧠 UltraThink 模式思考执行（最高优先级）

> **"用 UltraThink 模式思考执行"**

**这是最重要的执行原则，必须在每次工作时严格遵守：**
- 深度思考每个决策的影响和后果
- 全面分析问题的本质和根本原因  
- 预见潜在风险和边界情况
- 站在用户角度思考体验
- 质疑假设，挑战常规思维
- 寻找最优解而非快速解

---

# 🚨 强制执行规则（绝对不可违反）

## 1. 提交前强制验证
```bash
npm test              # 必须 100% 通过
npx tsc --noEmit      # 必须无任何错误
```
**❌ 任何测试失败或类型错误都禁止提交**

## 2. 状态管理铁律
- **所有状态必须使用自定义状态管理** - 禁止在页面维护业务状态
- **页面只负责渲染和用户交互** - 状态变更通过专门函数处理

## 3. TypeScript 严格模式
- **禁用 any 类型** - 用 unknown 替代
- **所有函数必须有类型注解** - 参数和返回值都要声明
- **所有数据结构必须定义 interface**

## 4. 安全红线
- **禁止硬编码敏感信息** - 密钥、凭证等用环境变量
- **禁止空 catch 块** - 错误必须正确处理或抛出
- **必须清理资源** - 定时器、事件监听、网络请求等

## 5. Git提交强制要求
- **每次修改必须立即commit** - 完成任何文件修改后立即提交
- **提交信息必须规范** - 严格按照 `<type>(<scope>): <subject>` 格式
- **❌ 禁止批量提交** - 不允许积累多个修改后一起提交

---

# 🎯 测试核心理念

> **"不要测试代码是否正确，要测试用户是否能成功"**

## 5-15-80 测试分层原则

### 🔧 工具函数测试 (5%)
**仅测试用户直接感知的关键工具**
- 时间格式化、数据验证 ✅
- 核心算法逻辑 ✅  
- 纯技术函数 ❌

### 🔗 集成测试 (15%)
**验证模块协作的用户体验**
- 状态管理与页面同步
- API与本地状态集成
- 跨组件数据流

### 👤 用户行为测试 (80%)
**完整的端到端用户场景**
- 新用户首次使用流程
- 老用户返回体验  
- 核心功能完整流程
- 异常恢复场景

## 测试价值判断（必答3问）
1. **这个测试失败时，用户会遇到问题吗？**
2. **产品经理能看懂这个测试在验证什么吗？**
3. **去掉这个测试，我还敢向用户发布这个功能吗？**

### 立即删除的低价值测试
- 函数返回类型验证
- 内部实现细节测试
- 过度技术化验证
- 重复场景测试

## 🔥 Mock 使用铁律（防止测试质量毒药）

> **"Mock 越多，测试价值越低"**

### Mock 密度法则（绝对不可违反）
- **0-1个 Mock** → 高价值测试 ✅
- **2-3个 Mock** → 谨慎评估，极可能删除 ⚠️  
- **4+ 个 Mock** → 立即删除，毫不犹豫 ❌

### 🚨 Mock 使用红线
**绝对禁止 Mock：**
- ❌ 自己写的业务代码
- ❌ 页面生命周期方法
- ❌ 状态管理函数  
- ❌ 用户交互逻辑

**谨慎 Mock：**
- ⚠️ 微信官方API（大多数情况下不需要）
- ⚠️ 网络请求（简单场景手工测试更好）

### Mock 替代方案
**不要用技术Mock，用业务模拟：**
```javascript
// ❌ 技术Mock - 测试技术实现
mockPageInstance.setData = jest.fn()
expect(mockPageInstance.setData).toHaveBeenCalled()

// ✅ 业务模拟 - 测试用户体验  
function simulateUserLogin(userInfo) {
  setUserInfo(userInfo)
  return checkHasUserInfo()
}
```

## 🚀 用户价值导向TDD流程（必须遵守）

> **"先写用户测试，再写功能实现"**

### TDD四步法则
1. **用户故事** - 描述用户完整操作场景
2. **红灯测试** - 编写失败的用户行为测试
3. **绿灯实现** - 最小化代码让测试通过
4. **蓝灯重构** - 在测试保护下优化代码

### 测试先行三原则
- **用户场景描述** - 先描述完整用户操作流程
- **失败驱动开发** - 让测试失败，然后实现功能  
- **小步快跑** - 每次只实现一个小功能点

## 🛑 测试停止信号（避免过度工程化）

**当出现以下情况，立即停止写测试：**
- ❌ 花更多时间解决测试技术问题，而不是验证用户价值
- ❌ 测试代码比被测代码更复杂
- ❌ 为了提高覆盖率而写测试
- ❌ 测试描述中有"mock"、"模拟"、"验证调用"等技术词汇
- ❌ 产品经理看不懂测试在验证什么

**正确的测试停止点：**
- ✅ 所有核心用户流程已覆盖
- ✅ 现有测试快速执行且稳定
- ✅ 团队对代码质量有信心
- ✅ 手工测试能快速发现问题

---

# 📋 编码规范

## 错误处理
- **Fail-Fast 机制** - 不能处理的错误立即抛出
- **禁止静默处理** - 错误必须记录或抛出
- **明确错误边界** - 在合适层级处理

## 函数设计
- **职责单一** - 每个函数只做一件事
- **参数明确** - 避免 flag、data 等模糊名称
- **少用默认参数** - 明确传递所有参数

## 生命周期
- **页面 onUnload** - 清理定时器、取消请求、解绑事件
- **及时释放** - 大对象引用、WebSocket连接等

---

# ⚡ 快速检查清单

## 编码前
- [ ] 能完整描述用户使用场景吗？
- [ ] 已有测试覆盖了类似场景吗？
- [ ] 状态管理使用自定义状态管理？

## 编码中  
- [ ] 避免使用 any 类型？
- [ ] 函数有完整类型注解？
- [ ] 测试模拟真实用户操作？
- [ ] 错误正确处理（无空catch）？
- [ ] 无硬编码敏感信息？
- [ ] **每次文件修改后立即commit？**

## 提交前
- [ ] `npm test` 100% 通过？
- [ ] `npx tsc --noEmit` 无错误？
- [ ] 关键用户流程100%覆盖？
- [ ] 删除了技术化测试？
- [ ] **所有修改已commit并推送？**
- [ ] **Git提交信息严格规范？**
- [ ] 生命周期正确管理？

---

# 📚 参考信息

## Git 提交格式
```
<type>(<scope>): <subject>
```
**Type**: feat/fix/docs/style/refactor/test/chore  
**Scope**: pages/components/utils/config/api

## 测试命令
```bash
npm test                    # 运行所有测试
npm run test:watch          # 监听模式
npm run test:coverage       # 覆盖率报告
```

## 微信小程序特性
- 开发者工具内置 TypeScript 编译器
- typings 目录提供完整 API 类型
- 无需复杂模块解析配置