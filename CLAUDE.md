# 微信小程序项目 - 开发规范

**项目基础**：TypeScript + 微信开发者工具 + ccstate状态管理

---

# 🚨 强制执行规则（绝对不可违反）

## 1. 提交前强制验证
```bash
npm test              # 必须 100% 通过
npx tsc --noEmit      # 必须无任何错误
```
**❌ 任何测试失败或类型错误都禁止提交**

## 2. 状态管理铁律
- **所有状态必须使用 ccstate** - 禁止在页面维护业务状态
- **页面只负责渲染和用户交互** - 状态变更通过专门函数处理

## 3. TypeScript 严格模式
- **禁用 any 类型** - 用 unknown 替代
- **所有函数必须有类型注解** - 参数和返回值都要声明
- **所有数据结构必须定义 interface**

## 4. 安全红线
- **禁止硬编码敏感信息** - 密钥、凭证等用环境变量
- **禁止空 catch 块** - 错误必须正确处理或抛出
- **必须清理资源** - 定时器、事件监听、网络请求等

## 5. Git提交强制要求
- **每次修改必须立即commit** - 完成任何文件修改后立即提交
- **提交信息必须规范** - 严格按照 `<type>(<scope>): <subject>` 格式
- **❌ 禁止批量提交** - 不允许积累多个修改后一起提交

---

# 🎯 测试核心理念

> **"不要测试代码是否正确，要测试用户是否能成功"**

## 5-15-80 测试分层原则

### 🔧 工具函数测试 (5%)
**仅测试用户直接感知的关键工具**
- 时间格式化、数据验证 ✅
- 核心算法逻辑 ✅  
- 纯技术函数 ❌

### 🔗 集成测试 (15%)
**验证模块协作的用户体验**
- 状态管理与页面同步
- API与本地状态集成
- 跨组件数据流

### 👤 用户行为测试 (80%)
**完整的端到端用户场景**
- 新用户首次使用流程
- 老用户返回体验  
- 核心功能完整流程
- 异常恢复场景

## 测试价值判断（必答3问）
1. **这个测试失败时，用户会遇到问题吗？**
2. **产品经理能看懂这个测试在验证什么吗？**
3. **去掉这个测试，我还敢向用户发布这个功能吗？**

### 立即删除的低价值测试
- 函数返回类型验证
- 内部实现细节测试
- 过度技术化验证
- 重复场景测试

---

# 📋 编码规范

## 错误处理
- **Fail-Fast 机制** - 不能处理的错误立即抛出
- **禁止静默处理** - 错误必须记录或抛出
- **明确错误边界** - 在合适层级处理

## 函数设计
- **职责单一** - 每个函数只做一件事
- **参数明确** - 避免 flag、data 等模糊名称
- **少用默认参数** - 明确传递所有参数

## 生命周期
- **页面 onUnload** - 清理定时器、取消请求、解绑事件
- **及时释放** - 大对象引用、WebSocket连接等

---

# ⚡ 快速检查清单

## 编码前
- [ ] 能完整描述用户使用场景吗？
- [ ] 已有测试覆盖了类似场景吗？
- [ ] 状态管理使用 ccstate？

## 编码中  
- [ ] 避免使用 any 类型？
- [ ] 函数有完整类型注解？
- [ ] 测试模拟真实用户操作？
- [ ] 错误正确处理（无空catch）？
- [ ] 无硬编码敏感信息？
- [ ] **每次文件修改后立即commit？**

## 提交前
- [ ] `npm test` 100% 通过？
- [ ] `npx tsc --noEmit` 无错误？
- [ ] 关键用户流程100%覆盖？
- [ ] 删除了技术化测试？
- [ ] **所有修改已commit并推送？**
- [ ] **Git提交信息严格规范？**
- [ ] 生命周期正确管理？

---

# 📚 参考信息

## Git 提交格式
```
<type>(<scope>): <subject>
```
**Type**: feat/fix/docs/style/refactor/test/chore  
**Scope**: pages/components/utils/config/api

## 测试命令
```bash
npm test                    # 运行所有测试
npm run test:watch          # 监听模式
npm run test:coverage       # 覆盖率报告
```

## 微信小程序特性
- 开发者工具内置 TypeScript 编译器
- typings 目录提供完整 API 类型
- 无需复杂模块解析配置