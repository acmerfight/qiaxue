# 项目说明

**这是一个微信小程序项目**
- 使用 TypeScript 开发
- 使用微信开发者工具进行编译和调试
- 遵循微信小程序开发规范

# 🚨 必须遵守的核心规范

## 1. 状态管理 - 使用 ccstate
- **所有状态使用 ccstate 管理** - 业务数据、用户状态、页面状态统一通过 ccstate 处理
- **页面只负责渲染和交互** - 页面文件仅处理 UI 展示和用户操作，不维护业务状态
- **状态变更通过专门函数** - 创建独立的状态管理函数，页面调用这些函数修改状态

## 2. 测试最佳实践 - 质量驱动的TDD模式

### 🎯 核心测试原则
- **先写测试再写代码** - 新功能必须先编写测试用例，然后实现功能
- **测试真实状态变化** - 测试重点关注状态管理逻辑和集成功能，不测试 UI 渲染
- **避免使用 mock** - 尽量测试真实的状态流转和数据处理，减少 mock 依赖，mock 越少越好
- **质量优于数量** - 20个精准测试胜过40个重复测试，专注核心业务价值
- **测试文件位置** - 在对应功能目录下创建 `*.test.ts` 文件

### 🔍 重复测试识别与清理标准

#### 立即删除的测试类型：
- **完全重复的测试文件** - 两个文件测试相同的函数和逻辑
- **TypeScript类型检查测试** - `expect(typeof result).toBe('string')` 等编译器能保证的测试
- **过度格式验证测试** - 正则匹配、分隔符检查等低价值测试
- **功能重复的测试用例** - 在同一文件中多次验证相同的业务逻辑

#### 重复识别的具体标准：
```typescript
// ❌ 重复测试示例 - 两个测试验证相同逻辑
test('getUserInfo 应该返回当前用户信息', () => {
  // 与其他测试中的 getUserInfo 验证重复
})

// ❌ 无价值测试示例 - TypeScript已保证类型安全
test('应该返回字符串类型', () => {
  expect(typeof formatTime(date)).toBe('string')
})

// ✅ 有价值测试示例 - 核心业务逻辑
test('setUserInfo 应该正确设置用户信息并更新状态', () => {
  // 测试核心状态管理逻辑
})
```

### 📊 测试分层架构 (3-2-1原则)

#### 单元测试 (70%) - 专注核心函数
- **状态管理函数** - ccstate操作的关键业务逻辑
- **工具函数** - 只测试核心场景和关键边界情况（不要过度测试）
- **数据处理函数** - 关键的数据转换和验证逻辑

#### 集成测试 (20%) - 验证组件协作
- **完整业务流程** - 用户注册、登录、状态更新等端到端场景
- **状态与页面交互** - 页面调用状态管理的真实集成
- **API与状态集成** - 网络请求与状态更新的完整流程

#### 端到端测试 (10%) - 关键用户旅程
- **核心用户场景** - 最重要的用户使用路径
- **异常处理流程** - 网络错误、权限失败等异常恢复

### 🚨 测试质量守护规则

#### 测试价值评估标准：
- **高价值** - 测试核心业务逻辑、状态管理、用户关键流程
- **中等价值** - 测试边界情况、异常处理、数据验证
- **低价值** - 测试工具函数的细节、类型检查、格式验证
- **无价值** - 测试TypeScript能保证的类型安全、重复的业务逻辑

#### 强制删除触发条件：
- 发现2个以上文件测试相同逻辑时，**立即删除重复文件**
- 单个函数测试用例超过5个时，**审查是否过度测试**
- 测试运行时间超过5秒时，**清理无价值测试**

### 🛠️ 测试维护与优化流程

#### 定期测试审查（每2周）：
1. **识别重复测试** - 使用测试覆盖率工具分析重复逻辑
2. **评估测试价值** - 删除低价值和无价值测试
3. **优化测试性能** - 清理过度细致的工具函数测试
4. **确保核心覆盖** - 验证关键业务逻辑100%覆盖

#### 测试重构标准：
- **测试文件行数超过200行** - 拆分或删除冗余测试
- **单个describe块超过10个测试** - 合并相似测试或删除重复
- **测试运行失败率超过5%** - 重构不稳定的测试

### 🎮 测试运行命令
```bash
# 运行所有测试
npm test

# 监听模式运行测试（开发时推荐）
npm run test:watch

# 运行测试并生成覆盖率报告
npm run test:coverage
```

### ⚡ 测试检查清单
编码前：
- [ ] 这个功能是否需要先写测试？（TDD）
- [ ] 现有测试是否已覆盖类似逻辑？（避免重复）

编码中：
- [ ] 测试是否专注核心业务价值？
- [ ] 是否避免了TypeScript类型检查测试？
- [ ] 是否测试了真实状态变化而非mock？

提交前：
- [ ] 是否删除了重复和无价值测试？
- [ ] 测试覆盖率是否保持在核心业务逻辑100%？
- [ ] 测试运行时间是否合理（<5秒）？

## 3. TypeScript 类型检查
### 编码要求
- **禁用 any 类型** - 除极特殊情况外，不使用 any，用 unknown 替代
- **定义完整接口** - 所有数据结构、API 响应、状态对象都要有明确 interface
- **函数类型注解** - 所有函数参数和返回值必须声明类型

### 提交前必须执行
**每次代码修改后必须运行以下命令并确保全部通过**
```bash
# 1. 运行所有测试（必须 100% 通过）
npm test

# 2. 运行 TypeScript 类型检查（必须无错误）
npx tsc --noEmit
```
- **测试必须 100% 通过** - 任何测试失败都不允许提交
- **类型检查必须无错误** - 任何 TypeScript 错误都不允许提交
- **TDD 流程** - 新功能必须先写测试，确保测试失败，然后实现功能使测试通过

## 4. Git 提交规范
### 自动提交要求
每次修改文件后必须自动进行 commit。

### 提交信息格式
```
<type>(<scope>): <subject>

<body>
```

**Type 类型**：
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档修改
- `style`: 代码格式修改（不影响代码运行）
- `refactor`: 重构代码
- `test`: 测试用例修改
- `chore`: 构建过程或辅助工具的变动

**Scope 范围**（可选）：
- `pages`: 页面相关
- `components`: 组件相关
- `utils`: 工具函数
- `config`: 配置文件
- `api`: 接口相关

# 📋 编码细节规范

## 错误处理规范
- **严格遵循 Fail-Fast 机制** - 遇到不能处理的错误必须立即抛出，绝对不能静默处理
- **禁止空 catch 块** - 不允许 `catch(e) {}` 这种什么都不做的异常处理
- **明确错误边界** - 错误应该在合适的层级被处理，不能在底层吞掉所有异常
- **记录关键错误** - 重要的错误信息必须记录，便于调试和追踪

## 函数设计规范
- **尽量少使用默认参数** - 默认参数会让代码难以理解，优先使用明确的参数传递
- **函数职责单一** - 每个函数只做一件事，避免参数过多和逻辑复杂
- **参数语义明确** - 参数名称要能清楚表达含义，避免使用 flag、data 等模糊名称

## 数据安全规范
- **禁止硬编码敏感信息** - API密钥、用户凭证、服务器地址等必须通过环境变量或配置文件管理
- **用户数据脱敏** - 日志中不能包含用户隐私信息（手机号、密码、身份证等）
- **接口权限验证** - 所有接口调用必须有合适的权限检查，验证用户身份
- **数据传输加密** - 敏感数据传输必须使用 HTTPS，重要数据考虑额外加密

## 生命周期管理
- **清理定时器** - 页面 onUnload 时必须清理所有 setTimeout/setInterval
- **取消请求** - 页面销毁时取消未完成的网络请求，避免回调执行报错
- **事件解绑** - 组件销毁时解绑全局事件监听，防止内存泄漏
- **资源释放** - 及时释放大对象引用、关闭 WebSocket 连接等

# 💡 微信小程序特殊说明

## TypeScript 配置 - 无需关注的问题
- **无需安装 typescript 包** - 微信开发者工具内置 TypeScript 编译器
- **无需 outDir/rootDir** - 微信开发者工具自动处理编译输出
- **无需复杂的模块解析配置** - 小程序有自己的模块系统
- **当前 tsconfig.json 已足够严格** - 已启用 strict 模式和各种检查

## 已配置完善的部分
- project.config.json 已启用 typescript 插件
- typings 目录提供完整的微信 API 类型定义
- miniprogram-api-typings 提供官方类型支持

# ⚡ 快速检查清单

编码前：
- [ ] 是否需要先写测试？（TDD）
- [ ] 现有测试是否已覆盖类似逻辑？（避免重复）
- [ ] 状态管理是否使用 ccstate？

编码中：
- [ ] 是否避免使用 any 类型？
- [ ] 函数是否有完整的类型注解？
- [ ] 测试是否专注核心业务价值？
- [ ] 是否避免了TypeScript类型检查测试？
- [ ] 错误是否正确处理（无空 catch）？
- [ ] 是否有硬编码的敏感信息？

提交前：
- [ ] 运行 `npm test` 100% 通过？
- [ ] 运行 `npx tsc --noEmit` 无错误？
- [ ] 是否删除了重复和无价值测试？
- [ ] 测试运行时间是否合理（<5秒）？
- [ ] Git 提交信息格式正确？
- [ ] 生命周期是否正确管理？